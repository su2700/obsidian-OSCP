# 什么是 Certipy（一句话）

Certipy 是一个专门用于 **Active Directory PKI/证书服务（AD CS）** 枚举与漏洞检测的开源工具。它能帮你发现与证书、CA、模板、私钥滥用相关的弱点，找到可用于横向移动或特权升级的 PKI 漏洞。

# 为什么用 Certipy（核心理由）

1. **专注于 AD PKI 这一薄弱面**
    
    - 传统渗透工具侧重于 SMB、Kerberos、LDAP 等；Certipy 填补了 AD 证书/CA 这块专门的检测空白。很多组织忽视 PKI 的配置错误，导致高价值的特权滥用路径存在。
        
2. **自动化枚举与易于发现问题**
    
    - 自动列出企业 CA、证书模板、ACL、签发历史、可请求的模板等，快速定位不安全的模板或过宽的权限（比如某模板允许任意用户替别人申请证书）。
        
3. **发现高价值利用点**
    
    - 能检测到像“可被非授权用户请求高特权证书”、“模糊签名/模板配置不当”、“CA 权限被错误分配”等，这些一旦存在通常能实现**持久化或特权横向移动**。
        
4. **支持多种工作流（渗透与防御双向价值）**
    
    - 渗透测试者用它找“可利用的证书路径”；防守方或蓝队可用它来审计 PKI 配置、修补策略与检测异常证书行为。
        
5. **输出有用的证书材料与线索**
    
    - 它能导出证书、CSRs、以及显示哪些账户有模板控制权，这些信息对后续分析/修复非常有帮助。
## 1. 什么是 AD PKI？

AD PKI 就是 **微软在 Active Directory 环境里实现的公钥基础设施**。它基于 Windows Server 的 **Active Directory Certificate Services (AD CS)** 提供证书颁发、管理、吊销和验证功能。  
👉 简单说：它让域用户、计算机、服务可以通过数字证书来进行 **身份认证、加密、签名**。

---

## 2. 核心组成

1. **证书颁发机构（CA, Certificate Authority）**
    
    - 根 CA（Root CA）：最高信任源，一般离线保存，极少使用。
        
    - 下级/企业 CA（Issuing CA）：日常发放和管理证书。
        
2. **证书模板（Certificate Templates）**
    
    - 定义了证书的用途、谁能申请、证书包含哪些字段等。
        
    - 例如“用户身份验证证书”、“Web 服务器 SSL 证书”。
        
3. **证书注册与自动注册（Enrollment / Auto-Enrollment）**
    
    - 用户或计算机可以手动或自动从 CA 请求证书。
        
    - 组策略可控制自动下发证书（比如域用户自动获得登录证书）。
        
4. **CRL / OCSP**
    
    - **证书吊销列表（CRL）** 和 **在线证书状态协议（OCSP）**：用来检查证书是否被撤销。
        

---

## 3. 常见用途

- **身份认证**：用户登录、计算机加入域、智能卡登录。
    
- **加密通信**：TLS/SSL（HTTPS、LDAPS、RDP）、邮件加密 (S/MIME)。
    
- **代码签名/文档签名**：验证发布者身份、防篡改。
    
- **无线/VPN 认证**：基于证书的 802.1X 或 VPN 身份验证。
    

---

## 4. 安全风险（渗透测试/蓝队都很重要）

- **配置错误的证书模板**：
    
    - 低权限用户可以请求高权限证书（例如带有 `Client Authentication` 用途的证书）。
        
- **过宽的 ACL 权限**：
    
    - 普通用户能修改证书模板或 CA 配置。
        
- **弱加密算法**：
    
    - 使用已弃用的 MD5/SHA1，导致被伪造风险。
        
- **证书滥用**：
    
    - 攻击者通过获取高权限账户的证书，可以持久化访问（即使密码更改，证书仍然有效）。
        

---

## 5. 相关工具

- **Certutil**（Windows 自带工具，用于查看/管理证书）。
    
- **Certipy**（红队/CTF 常用，自动枚举 AD CS 配置并找漏洞）。
    
- **PSPKIAudit**、**ADCSAudit**（蓝队常用，检查 PKI 配置弱点）。